# DeepcoMini LED 사용법

## 1) LED 구성/핀맵(보드 기준)

- **중앙 LED(1개 RGB LED, RGB 채널 순서)**: GPIO **2**
  - **특징**: 1픽셀 LED이며, **RGB 형식**(채널 순서)
- **오른쪽 NeoPixel(4개, GRB)**: GPIO **47**
  - **특징**: **GRB 방식**(채널 순서)
- **왼쪽 NeoPixel(4개, GRB)**: GPIO **48**
  - **특징**: **GRB 방식**(채널 순서)

> 참고: 좌/우 NeoPixel은 각각 4픽셀 스트립(또는 4-in-1)이라 “애니메이션 표현”에 유리합니다.

---

## 2) 표현해야 하는 상태(권장)

LED는 “표현”만 담당하고, 네트워크/소켓 이벤트는 **상태만 갱신**하도록 설계합니다.

- **BOOTING**: 전원 인가 ~ 시스템 준비 중
- **READY**: SoftAP/WebServer/WebSocket 준비 완료, 아직 클라이언트 연결 없음(SoftAP에 STA 미연결)
- **WIFI_CONNECTED**: 로봇 SoftAP에 **Station(예: PC USB 동글)** 이 Wi‑Fi로 연결됨(association 됨), 아직 `/ws`는 미연결
- **CONNECTED**: 웹 UI(AsyncWebSocket `/ws`) 클라이언트가 연결됨
  - 카메라 연결(`:81`)은 웹 UI 연결과 거의 동시에 일어나는 것으로 가정하고, **별도 상태/표시를 두지 않음**

### 우선순위(예시)

동시에 여러 상태가 성립할 수 있으므로, 최종 표시 상태는 우선순위로 결정합니다.

`CONNECTED > WIFI_CONNECTED > READY > BOOTING`

---

## 3) 부팅(BOOTING) 표현(좌/우 + 중앙 권장안)

### 좌/우 NeoPixel(각 4픽셀)

- **프로그레스 바(권장)**: 부팅 단계에 따라 0→4 픽셀을 순차 점등
  - 예: 250ms 간격으로 한 칸씩 채우기(좌/우 동시에)
- **Chase(대안)**: 1픽셀이 이동하는 효과(4픽셀 루프)

### 중앙 LED(1개 RGB LED, RGB 채널 순서)

- **부드러운 숨쉬기(breathing)**로 “부팅 중”을 명확히 표시
  - 중앙 LED는 **색(R/G/B 혼합)** 표현이 가능하지만, **픽셀이 1개뿐**이라(NeoPixel 스트립처럼 여러 픽셀 애니메이션 불가)
    상태 표현은 **밝기 변화/깜빡임 패턴(주기/듀티)**로 주는 방식이 가장 직관적입니다.

---

## 4) 소켓 연결 상태 표현(부팅과 다른 방식 권장)

부팅은 시간이 걸리지만 소켓 연결은 매우 빠르게 완료되므로, “연결 과정(순간 이벤트)”은 생략하고 **연결된 상태의 지속 표현**과 **연결 해제(끊김) 이벤트 표현**에 집중합니다.

### `/ws` (웹 UI) 연결

- **연결 유지**
  - 중앙 LED: **초록 heartbeat**(짧게 ON, 길게 OFF)
  - 좌/우 NeoPixel: **파랑 고정 점등**, 밝기(듀티) **약 50%**
  - READY와 구분되도록 주기/듀티(또는 색상)를 다르게 권장

### 연결 해제

- **해제 순간**: 좌/우 NeoPixel을 **빨강 1회 길게(예: 300ms)** 점등
- **해제 후**: READY 패턴으로 복귀

---

## 5) 상태별 LED 동작 테이블(현재 코드 기준)

| **상태** | **언제** | **좌/우 NeoPixel(각 4개, GPIO48/47, GRB)** | **가운데 LED(1개, GPIO2, RGB)** |
|---|---|---|---|
| **BOOTING** | 전원 켠 직후 ~ 약 **3초** | **파랑 progress bar**: 250ms마다 0→4칸 채워졌다가 반복 | **흰색 breathing**: 밝기 0→255→0 (약 2초 주기) |
| **READY** | 부팅 이후, `/ws` 연결 전 | **꺼짐** | **은은한 빨강 breathing(gradation)**: 밝기 0→상승→0 (약 2초 주기) |
| **WIFI_CONNECTED** | SoftAP에 동글(Station) 연결됨, `/ws` 연결 전 | **꺼짐** | **은은한 초록 breathing**: (G) 밝기 0→상승→0 (약 2초 주기, dim) |
| **CONNECTED** | `/ws` 연결된 동안 | **파랑 고정 점등**, 밝기 **약 50%** | **은은한 초록 고정 점등**(점멸 없음) |
| **DISCONNECT 이벤트** | `/ws` 연결이 끊기는 순간 | **빨강 1회 길게 점등**(약 300ms) 후 READY로 복귀 | 끊김 중에도 중앙 heartbeat는 계속 동작(이벤트는 좌/우만 오버레이) |

---

## 6) 구현 전략(중요)

### 6.1 논블로킹(Non-blocking) 필수

카메라 스트리밍/웹소켓 처리를 막지 않도록, LED 애니메이션은 `delay()`로 구현하지 않고 다음 방식 중 하나로 구현합니다.

- **millis() 기반 프레임 업데이트**: 일정 주기(예: 20~50ms)마다 LED를 갱신
- **FreeRTOS Task 분리(낮은 우선순위)**: LED 전용 태스크를 두고 주기적으로 업데이트

### 6.2 상태 머신(권장 구조)

- 소켓 이벤트 핸들러에서 **LED를 직접 복잡하게 깜빡이지 말고**
  - `status = SOCKET_CONNECTED` 같은 방식으로 “상태만” 바꿉니다.
- LED 업데이트 루프(또는 태스크)는
  - 현재 `status`에 맞는 패턴을 계산해서 출력합니다.

---

## 7) 현재 코드에서 상태를 잡는 위치(참고)

현재 스케치(`DeepcoMini_v1.0.ino`) 기준으로, 아래 이벤트에서 상태를 갱신하면 자연스럽습니다.

- **웹 UI 소켓(`/ws`)**: `onEvent()`의 `WS_EVT_CONNECT / WS_EVT_DISCONNECT`
  - 카메라 소켓(`:81`)은 별도 표시를 하지 않으므로, LED 상태 갱신 트리거는 `/ws`만 사용
- **SoftAP(로봇 AP) Wi‑Fi 연결**: `WiFi.onEvent()`의 `AP_STACONNECTED / AP_STADISCONNECTED`
  - 동글이 로봇 AP에 붙었는지(association)만 표시하고, 실제 제어 가능 여부는 `/ws` 연결로 판단


