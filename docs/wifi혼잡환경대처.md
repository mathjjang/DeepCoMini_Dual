# Wi‑Fi 혼잡환경 대처 (ESP32‑S3 SoftAP / 전시장용)

## 0) 대상/전제

- **보드**: ESP32‑S3
- **운영 모드**: **AP only (SoftAP)**  
  - `DeepcoMini_v1.3.ino`는 운영 중 `WIFI_AP`로 동작하며, 부팅 시 채널 선택을 위해 **일시적으로만** 스캔(`WIFI_AP_STA`) 후 다시 `WIFI_AP`로 복귀함.
- **대역**: 2.4GHz (SoftAP)
- **목표**: 혼잡한 전시장 환경에서
  - 끊김/지연/접속 실패 최소화
  - 다양한 스마트폰/노트북 호환성 최대화

---

## 1) 혼잡환경에서 문제가 생기는 이유(요약)

- **2.4GHz 간섭/경합**: 주변 AP가 많고 신호가 강하면 백오프/재전송이 늘어 지연/손실 증가
- **HT40(40MHz)**: 혼잡 환경에서는 채널 폭이 넓어져 충돌 가능성이 커지고 체감 성능이 떨어질 수 있음
- **채널 선택 실패**: 특정 채널(특히 1)로 몰리면 연결 품질이 급격히 악화
- **기기 호환성**: 12/13 채널은 일부 기기/국가 설정에서 스캔/접속이 안 될 수 있어 “현장 접속 실패” 원인이 됨

---

## 2) 핵심 권장 설정(전시장 기본값)

### 2.1 채널(Channel)

- **권장**: 2.4GHz **채널 6 또는 11** (대부분의 기기에서 호환성 최고)
- **비권장**: **채널 12/13**
  - 이론상 간섭이 적을 수 있으나, 일부 기기에서 AP를 못 보거나 접속 실패 가능

### 2.2 대역폭(Bandwidth)

- **권장**: **HT20(20MHz) 고정**
  - 혼잡 환경에서 안정성이 보통 더 좋음(넓게 쓰는 대신 충돌 감소)

### 2.3 출력(TX power)

- **원칙**: “무조건 높게”보다 **현장 동선/거리 기준으로 적정**이 안정적
  - 너무 높으면 근거리 간섭/왜곡·전류·발열이 증가할 수 있음
  - 너무 낮으면 QR로 접속은 되지만 조금만 멀어져도 끊김

### 2.4 최대 접속 수(Max connections)

- **권장**: 실제 필요한 수로 제한 (예: 1~4)
  - 의미 없는 연결 시도/브로드캐스트 부하 감소

---

## 3) 채널 선택 전략(현장 운영)

### 3.1 “자동 선택” 최소 버전

- 부팅 시 1회 스캔하고 채널을 선택한 뒤 SoftAP 시작
- 단, **STA로 연결하지는 않음**(스캔용으로만 APSTA 임시 사용)

### 3.2 채널 후보 집합

- **보수적(호환성 최우선)**: {6, 11}  
  - 현장에서 가장 안전
- **공격적(혼잡 회피)**: {1, 6, 11}  
  - 단, 1은 전시장에서는 종종 매우 혼잡
- **권장하지 않음**: {12, 13} 포함  
  - 기기 호환성 리스크

---

## 4) 현장 진단 방법(PC 기준)

### 4.1 주변 AP 혼잡도 측정(채널별)

- `DeepCoConnector/scripts/wifi_channel_survey.ps1` 사용
  - 2.4GHz 채널 **1~13**에 대해
    - **Count**(BSSID 개수)
    - **AvgSignalPct / MaxSignalPct**
    - 옵션: **SumSignalPct**(가중치 힌트)

### 4.2 해석 가이드

- **Count가 낮을수록**: 경쟁 AP가 적을 가능성 ↑
- **MaxSignalPct가 높으면**: “아주 가까운 강한 AP”가 있을 수 있어 체감 간섭 ↑ 가능
- 전시장은 시간이 지나며 변동하므로, **2~3회 반복** 후 경향으로 판단

---

## 5) 적용 계획(코드 변경 항목)

`DeepcoMini_v1.3.ino`에 아래를 **최소 변경**으로 적용하는 것을 목표로 함.

1. **SoftAP HT20 고정**
2. **SoftAP 채널 자동 선택**은 유지하되, 후보/로직을 문서 기준으로 확정(기본 6/11)
3. 필요 시 **max_connection** 설정 추가
4. 필요 시 **TX power**를 현장 기준으로 튜닝 가능한 상수로 노출

---

## 6) 현재 코드 적용값(DeepcoMini_v1.3 기준)

- **채널**: 부팅 시 스캔 후 **6 또는 11** 자동 선택
- **대역폭**: **HT20 고정**
- **max_connection**: **4**
- **SSID 숨김(ssid_hidden)**: **0**(브로드캐스트)
- **TX power**: 기본값 유지(코드에서는 `SOFTAP_TX_POWER = -1`)

---

## 7) 전시장 추천(초안)

- **채널**: 자동 선택 후보는 **6/11 유지** (호환성/안정성 우선)
- **대역폭**: **HT20 고정**
- **TX power**: 현장 거리/장애물 기준으로 단계적으로 조정(테스트 후 확정)
- **max_connection**: 1~4 범위에서 요구사항에 맞춰 제한

